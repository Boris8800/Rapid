name: rapidroads-monitoring

networks:
	monitoring:
	internal:
		external: true
		name: rapidroads_internal

volumes:
	prometheus_data:
	grafana_data:
	promtail_positions:

services:
	prometheus:
		image: prom/prometheus:v2.55.1
		container_name: rapidroads-prometheus
		volumes:
			- ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
			- prometheus_data:/prometheus
		command:
			- --config.file=/etc/prometheus/prometheus.yml
			- --storage.tsdb.path=/prometheus
		networks:
			- monitoring
			- internal
		restart: unless-stopped

	alertmanager:
		image: prom/alertmanager:v0.27.0
		container_name: rapidroads-alertmanager
		volumes:
			- ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
		command:
			- --config.file=/etc/alertmanager/alertmanager.yml
		networks:
			- monitoring
		restart: unless-stopped

	loki:
		image: grafana/loki:3.2.1
		container_name: rapidroads-loki
		command: -config.file=/etc/loki/config.yml
		volumes:
			- ./monitoring/loki/config.yml:/etc/loki/config.yml:ro
		networks:
			- monitoring
		restart: unless-stopped

	promtail:
		image: grafana/promtail:3.2.1
		container_name: rapidroads-promtail
		command: -config.file=/etc/promtail/config.yml
		volumes:
			- ./monitoring/promtail/config.yml:/etc/promtail/config.yml:ro
			- /var/lib/docker/containers:/var/lib/docker/containers:ro
			- /var/log:/var/log:ro
			- promtail_positions:/tmp
		networks:
			- monitoring
		restart: unless-stopped

	grafana:
		image: grafana/grafana:11.4.0
		container_name: rapidroads-grafana
		environment:
			GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
			GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-ChangeMeNow!}
		volumes:
			- grafana_data:/var/lib/grafana
			- ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
			- ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
		networks:
			- monitoring
		restart: unless-stopped
